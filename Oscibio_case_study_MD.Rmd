---
title: "Case Study OSCIBIO"
author: "Nicolas Vanermen"
date: "2/02/2024"
output:
html_document:
df_print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Aim

This script allows one to download regional GBIF occurrences of a predefined species within Belgium. The results will be presented through a map of occurrences and a bar chart of the number of observations per year. The script further allows the user to define the year range.

This markdown document illustrates how to use the script in order to retrieve occurrence data of the invasive Asian hornet *Vespa velutina* in the Flanders region.

## Before you get started

Make sure to include your GBIF credentials in your R session:

library(usethis)<br>
usethis::edit_r_environ()

Edit your .Renviron to look like this:<br>
GBIF_USER="nicolasvanermen"<br>
GBIF_PWD="************"<br>
GBIF_EMAIL="nicolas.vanermen@inbo.be"<br>

Also see: https://docs.ropensci.org/rgbif/articles/gbif_credentials.html

To retrieve a boundary map of Flanders one needs the data package "rnaturalearthhires":<br>
install.packages("rnaturalearthhires", repos = "https://ropensci.r-universe.dev", type = "source")

```{r, include=FALSE}

library(ggplot2)
library(rgbif)
library(rnaturalearth)
library(sf)
library(mapview)
library(lubridate)
library(stringr)
```

## Execute the functions
### Download function

First we source two functions. The first intends to download the data, the other will generate the graphs. To execute the download function the user needs to define the species, the region and the period of interest.

```{r, include=TRUE, warning=FALSE}

source("./Oscibio case study functions.R")

#Define the input variables for download function
species_name <- "Vespa velutina"
selected_species <- name_backbone(str_replace(species_name, " ", "_"))$usageKey
selected_region <- ne_states(country = "Belgium", geounit = "Flemish Region", returnclass = "sf")
start_year <- 2020
end_year <- 2022

#Run the download function
Vespa_velutina_FL <- Download_GBIF_occurrences(selected_species, selected_region, start_year, end_year)
```

### Tests of the download function

To verify the functionality of the download function we perform three simple tests that should all generate a TRUE value.

<!-- #### Test the data graphically: -->

<!-- ```{r, include=FALSE} -->

<!-- Flanders <- ne_states(country = "Belgium", geounit = "Flemish Region", returnclass = "sf") -->
<!-- ``` -->

<!-- ```{r, echo=FALSE} -->

<!-- mapview(Vespa_velutina_FL, cex=0.3, col.regions = "black", layer.name='Vespa velutina (GBIF occurrences)') + mapview(Flanders, col.regions = "darkgreen", alpha.regions = 0.1) -->
<!-- ``` -->

#### Check whether the data exclusively hold the selected species:<br>
`r 
unique(Vespa_velutina_FL$species) == species_name
`\

#### Check whether the data are limited to the selected timespan:<br>
`r 
sum(ymd(paste(Vespa_velutina_FL$year,Vespa_velutina_FL$month,Vespa_velutina_FL$day)) %within%
      interval(ymd(paste(start_year,"0101")),ymd(paste(end_year,"1231")))) == 
nrow(Vespa_velutina_FL)
`\

#### Geographical range:

We first define a bounding box of the selected region<br>
(source:https://geometadatalabs.eu/index.php?title=Land_cover_Belgium_(Flanders)_1m_resolution_2012)

```{r, include=TRUE}

North <- 51.49590
East <- 5.92000
South <- 50.67480
West <- 2.56035
coord <- as.data.frame(st_coordinates(Vespa_velutina_FL))
#we allow a 0.1 degree relaxation on the geographical limits:
test <- sum(coord$X < East+0.1 &
              coord$X > West-0.1 & 
              coord$Y > South-0.1 & 
              coord$Y < North+0.1)
```

#### Check whether the data are within these geographical limits:<br>
`r 
test == nrow(Vespa_velutina_FL)
`\

### Graph function

First define the input variable for the graph generator (this is the file generated by the download function) and then run the function:
```{r, include=TRUE, warning=FALSE}

selected_file <- Vespa_velutina_FL

#Run the graph generator function
List <- Generate_map_and_histogram(Vespa_velutina_FL, selected_region)
```
<br>
<br>

## Enjoy the final output!<br>

```{r, echo=FALSE}
Map_Vespa_velutina_FL <- List[[1]]
Map_Vespa_velutina_FL
```

```{r, echo=FALSE}
Map_Vespa_velutina_FL_col_per_yr <- List[[2]]
Map_Vespa_velutina_FL_col_per_yr
```

```{r, echo=FALSE}
Hist_Vespa_velutina_FL <- List[[3]]
Hist_Vespa_velutina_FL
```
